<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0B1220;--card:#121826;--card-hover:#1a2235;
  --purple:#6D5EF6;--green:#25D27B;--teal:#20C4C6;
  --red:#EF4444;--yellow:#F59E0B;--orange:#F97316;
  --text:#E2E8F0;--text-dim:#94A3B8;--text-muted:#64748B;
  --border:#1E293B;--sidebar-w:240px;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:var(--sidebar-w);background:#0D1525;border-right:1px solid var(--border);position:fixed;top:0;left:0;bottom:0;display:flex;flex-direction:column;z-index:10}
.sidebar-brand{padding:24px 20px;font-size:18px;font-weight:700;color:var(--purple);display:flex;align-items:center;gap:10px}
.sidebar-brand .dot{width:10px;height:10px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.sidebar nav{flex:1;padding:8px 12px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;cursor:pointer;color:var(--text-dim);font-size:14px;font-weight:500;transition:all .2s;margin-bottom:2px}
.nav-item:hover{background:rgba(109,94,246,.1);color:var(--text)}
.nav-item.active{background:rgba(109,94,246,.15);color:var(--purple)}
.nav-item svg{width:20px;height:20px;flex-shrink:0}
.sidebar-footer{padding:16px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--text-muted)}

/* Main Content */
.main{margin-left:var(--sidebar-w);flex:1;padding:32px 40px}
.page-header{text-align:center;margin-bottom:32px}
.page-header h1{font-size:28px;font-weight:700;color:var(--text)}
.page-header p{font-size:14px;color:var(--text-dim);margin-top:4px}

/* Cards */
.card{background:var(--card);border-radius:10px;padding:24px;box-shadow:0 4px 24px rgba(0,0,0,.25);transition:transform .2s,box-shadow .2s;border-left:3px solid transparent}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.35)}
.card.accent-purple{border-left-color:var(--purple)}
.card.accent-green{border-left-color:var(--green)}
.card.accent-teal{border-left-color:var(--teal)}
.card.accent-yellow{border-left-color:var(--yellow)}
.card.accent-red{border-left-color:var(--red)}
.card.accent-orange{border-left-color:var(--orange)}

/* Grid */
.grid{display:grid;gap:20px}
.grid-4{grid-template-columns:repeat(4,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-1{grid-template-columns:1fr}

/* Stats */
.stat-label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.stat-value{font-size:28px;font-weight:700}
.stat-sub{font-size:12px;color:var(--text-dim);margin-top:4px}
.text-green{color:var(--green)}.text-red{color:var(--red)}.text-purple{color:var(--purple)}.text-teal{color:var(--teal)}.text-yellow{color:var(--yellow)}

/* Table */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 12px;color:var(--text-muted);font-weight:600;text-transform:uppercase;font-size:11px;letter-spacing:.5px;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid var(--border)}
tr:hover td{background:rgba(255,255,255,.02)}

/* Badge */
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-green{background:rgba(37,210,123,.15);color:var(--green)}
.badge-yellow{background:rgba(245,158,11,.15);color:var(--yellow)}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
.badge-purple{background:rgba(109,94,246,.15);color:var(--purple)}
.badge-teal{background:rgba(32,196,198,.15);color:var(--teal)}

/* Progress */
.progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;border-radius:4px;transition:width .5s}

/* Status dots */
.status-row{display:flex;gap:20px;justify-content:center;flex-wrap:wrap}
.status-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-dim)}
.status-dot{width:8px;height:8px;border-radius:50%}
.status-dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.off{background:var(--red)}

/* Tabs */
.tab-group{display:flex;gap:4px;margin-bottom:24px;background:#0D1525;border-radius:8px;padding:4px}
.tab-btn{padding:8px 20px;border:none;background:none;color:var(--text-dim);font-size:13px;font-weight:500;cursor:pointer;border-radius:6px;transition:all .2s;font-family:inherit}
.tab-btn.active{background:var(--purple);color:#fff}

/* Journal */
.journal-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow-y:auto}
.journal-item{padding:16px;background:var(--card);border-radius:8px;cursor:pointer;transition:all .2s;border-left:3px solid var(--purple)}
.journal-item:hover{background:var(--card-hover);transform:translateX(4px)}
.journal-item .date{font-weight:600;color:var(--purple);font-size:15px}
.journal-item .preview{color:var(--text-dim);font-size:13px;margin-top:4px}
.journal-viewer{background:var(--card);border-radius:10px;padding:32px;min-height:400px;font-size:14px;line-height:1.8}
.journal-viewer h1,.journal-viewer h2,.journal-viewer h3{color:var(--purple);margin:16px 0 8px}
.journal-viewer code{background:#1E293B;padding:2px 6px;border-radius:4px;font-size:13px}
.journal-viewer pre{background:#0D1525;padding:16px;border-radius:8px;overflow-x:auto;margin:12px 0}

/* Search */
.search-bar{width:100%;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:border-color .2s}
.search-bar:focus{border-color:var(--purple)}

/* Tags */
.tag-row{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
.tag{padding:4px 12px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--border);color:var(--text-dim);transition:all .2s}
.tag:hover,.tag.active{background:var(--purple);border-color:var(--purple);color:#fff}

/* Org Chart */
.org-chart{display:flex;flex-direction:column;align-items:center;gap:0;padding:20px 10px}
.org-node{background:var(--card);border:2px solid var(--border);border-radius:10px;padding:14px 24px;text-align:center;min-width:150px;position:relative;transition:transform .2s,box-shadow .2s}
.org-node:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.4)}
.org-node .name{font-weight:700;font-size:15px}
.org-node .role{font-size:11px;color:var(--text-dim);margin-top:2px}
.org-node .model-tag{font-size:10px;color:var(--text-muted);margin-top:4px;padding:2px 8px;background:rgba(255,255,255,.05);border-radius:4px;display:inline-block}
.org-node .status-dot{width:8px;height:8px;border-radius:50%;position:absolute;top:8px;right:8px}
.org-node .status-dot.active{background:var(--green);animation:pulse 2s infinite}
.org-node .status-dot.disabled{background:var(--text-muted)}
.org-connector{width:2px;height:20px;background:var(--border)}
.org-row{display:flex;gap:24px;justify-content:center;flex-wrap:wrap;position:relative}
.org-row::before{content:'';position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:calc(100% - 120px);height:2px;background:var(--border)}
.org-row-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin:8px 0 4px}
.org-branch{display:flex;gap:32px;position:relative}
.org-branch::before{content:'';position:absolute;top:-12px;left:50%;transform:translateX(-50%);width:calc(100% - 160px);height:2px;background:var(--border)}

/* Cron Card */
.cron-card{display:flex;align-items:center;gap:16px;padding:20px;background:var(--card);border-radius:10px;transition:transform .2s}
.cron-card:hover{transform:translateY(-2px)}
.cron-stripe{width:4px;height:48px;border-radius:2px}
.cron-info h3{font-size:15px;font-weight:600}
.cron-info p{font-size:12px;color:var(--text-dim);margin-top:2px}
.cron-meta{margin-left:auto;text-align:right;font-size:12px;color:var(--text-muted)}

/* Section hide/show */
.section{display:none}
.section.active{display:block}

/* Scrollbar */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Brain entry */
.brain-entry{background:var(--card);border-radius:10px;padding:20px;border-left:3px solid var(--teal);transition:transform .2s}
.brain-entry:hover{transform:translateY(-2px)}
.brain-entry h3{font-size:15px;font-weight:600;margin-bottom:8px}
.brain-entry .body{font-size:13px;color:var(--text-dim);line-height:1.6;white-space:pre-wrap}

@media(max-width:1200px){.grid-4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.grid-4,.grid-3,.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-brand"><span class="dot"></span> OpenClaw</div>
  <div style="padding:0 20px 12px;font-size:11px;color:var(--text-muted)">
    <span id="live-indicator" style="display:inline-block;width:6px;height:6px;background:var(--green);border-radius:50%;margin-right:4px;animation:pulse 2s infinite"></span>
    Live ¬∑ <span id="last-updated">--</span>
    <span id="refresh-spin" style="display:none;margin-left:6px">‚ü≥</span>
  </div>
  <nav>
    <div class="nav-item active" data-tab="overview">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Overview
    </div>
    <div class="nav-item" data-tab="trading">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22,7 13.5,15.5 8.5,10.5 2,17"/><polyline points="16,7 22,7 22,13"/></svg>
      Trading
    </div>
    <div class="nav-item" data-tab="tokens">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M6 12h12"/></svg>
      Tokens
    </div>
    <div class="nav-item" data-tab="agents">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Agents
    </div>
    <div class="nav-item" data-tab="schedule">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
      Schedule
    </div>
    <div class="nav-item" data-tab="journal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
      Journal
    </div>
    <div class="nav-item" data-tab="brain">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 0-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 0 0-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
      2nd Brain
    </div>
    <div class="nav-item" data-tab="finance">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Finance
    </div>
  </nav>
  <div class="sidebar-footer">
    <div style="display:flex;align-items:center;gap:8px"><span class="status-dot on"></span> System Online</div>
  </div>
</aside>

<!-- Main Content -->
<div class="main">

<!-- ‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê -->
<div class="section active" id="sec-overview">
  <div class="page-header">
    <h1>Dashboard Overview</h1>
    <p>Real-time system health and portfolio snapshot</p>
  </div>
  <div class="grid grid-4" id="overview-stats">
    <div class="card accent-green"><div class="stat-label">Equity</div><div class="stat-value text-green" id="ov-equity">‚Äî</div></div>
    <div class="card accent-purple"><div class="stat-label">Today's P&L</div><div class="stat-value" id="ov-pnl">‚Äî</div></div>
    <div class="card accent-teal"><div class="stat-label">Open Positions</div><div class="stat-value text-teal" id="ov-positions">‚Äî</div></div>
    <div class="card accent-yellow"><div class="stat-label">Win Rate</div><div class="stat-value text-yellow" id="ov-winrate">‚Äî</div></div>
  </div>
  <div style="margin-top:24px">
    <div class="card accent-purple">
      <div class="stat-label" style="margin-bottom:16px">System Status</div>
      <div class="status-row">
        <div class="status-item"><span class="status-dot on"></span> WhatsApp</div>
        <div class="status-item"><span class="status-dot on"></span> Crons</div>
        <div class="status-item"><span class="status-dot on"></span> Portal</div>
        <div class="status-item"><span class="status-dot on"></span> Gateway</div>
      </div>
    </div>
  </div>
  <div class="grid grid-2" style="margin-top:20px">
    <div class="card accent-teal">
      <div class="stat-label">Total Trades</div>
      <div class="stat-value text-teal" id="ov-trades">‚Äî</div>
      <div class="stat-sub">All-time closed trades</div>
    </div>
    <div class="card accent-green">
      <div class="stat-label">Cash Available</div>
      <div class="stat-value text-green" id="ov-cash">‚Äî</div>
      <div class="stat-sub">Buying power</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TRADING ‚ïê‚ïê‚ïê -->
<div class="section" id="sec-trading">
  <div class="page-header">
    <h1>Trading Floor</h1>
    <p>Active positions, equity curve, and signal indicators</p>
  </div>
  <div class="card accent-green" style="margin-bottom:20px">
    <div class="stat-label" style="margin-bottom:12px">Active Positions</div>
    <div class="table-wrap">
      <table id="positions-table">
        <thead><tr><th>Symbol</th><th>Qty</th><th>Entry</th><th>Current</th><th>P&L</th><th>P&L %</th></tr></thead>
        <tbody id="positions-body"><tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No open positions</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="grid grid-2">
    <div class="card accent-purple">
      <div class="stat-label" style="margin-bottom:12px">Equity Curve</div>
      <canvas id="equity-chart" height="200"></canvas>
    </div>
    <div class="card accent-teal">
      <div class="stat-label" style="margin-bottom:12px">Recent Trades</div>
      <div id="trades-feed" style="max-height:280px;overflow-y:auto;font-size:13px;color:var(--text-dim)">
        <div style="text-align:center;color:var(--text-muted)">No trades yet</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TOKENS ‚ïê‚ïê‚ïê -->
<div class="section" id="sec-tokens">
  <div class="page-header">
    <h1>Token Usage</h1>
    <p>API costs, token consumption, and budget tracking</p>
  </div>
  <div class="card accent-purple" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="stat-label">Budget Progress</div><div class="stat-value text-purple" id="tk-budget-text">‚Äî</div></div>
      <div style="text-align:right"><div class="stat-label">Budget</div><div style="font-size:20px;font-weight:600" id="tk-budget-total">‚Äî</div></div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="tk-budget-bar" style="width:0%;background:var(--purple)"></div></div>
  </div>
  <div class="grid grid-4" id="tk-metrics">
    <div class="card accent-green"><div class="stat-label">Budget Used</div><div class="stat-value text-green" id="tk-used">‚Äî</div></div>
    <div class="card accent-teal"><div class="stat-label">Daily Avg</div><div class="stat-value text-teal" id="tk-daily">‚Äî</div></div>
    <div class="card accent-yellow"><div class="stat-label">Projected Monthly</div><div class="stat-value text-yellow" id="tk-projected">‚Äî</div></div>
    <div class="card accent-purple"><div class="stat-label">Total Tokens</div><div class="stat-value text-purple" id="tk-tokens">‚Äî</div></div>
  </div>
  <div class="grid grid-2" style="margin-top:20px">
    <div class="card accent-green">
      <div class="stat-label" style="margin-bottom:8px">Input Tokens</div>
      <div class="stat-value text-green" id="tk-input" style="font-size:28px">‚Äî</div>
      <div class="stat-label" style="margin-top:4px;font-size:11px" id="tk-input-pct">‚Äî</div>
    </div>
    <div class="card accent-orange">
      <div class="stat-label" style="margin-bottom:8px">Output Tokens</div>
      <div class="stat-value text-yellow" id="tk-output" style="font-size:28px">‚Äî</div>
      <div class="stat-label" style="margin-top:4px;font-size:11px" id="tk-output-pct">‚Äî</div>
    </div>
  </div>
  <div class="grid grid-2" style="margin-top:20px">
    <div class="card accent-purple">
      <div class="stat-label" style="margin-bottom:8px">Sessions Parsed</div>
      <div class="stat-value text-purple" id="tk-sessions" style="font-size:28px">‚Äî</div>
    </div>
    <div class="card accent-teal">
      <div class="stat-label" style="margin-bottom:8px">Days Active</div>
      <div class="stat-value text-teal" id="tk-days" style="font-size:28px">‚Äî</div>
    </div>
  </div>
  <div class="card accent-teal" style="margin-top:20px">
    <div class="stat-label" style="margin-bottom:12px">Token Usage by Model</div>
    <div id="model-costs"></div>
  </div>
  <div class="card accent-purple" style="margin-top:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="stat-label">Token Consumption by Model</div>
      <div>
        <button class="tab-btn active" id="tok-daily-btn" onclick="renderModelChart('daily')">Daily</button>
        <button class="tab-btn" id="tok-monthly-btn" onclick="renderModelChart('monthly')">Monthly</button>
      </div>
    </div>
    <canvas id="model-line-chart" height="280"></canvas>
  </div>
  <div class="grid grid-2" style="margin-top:20px">
    <div class="card accent-teal">
      <div class="stat-label" style="margin-bottom:12px">Cost by Provider</div>
      <canvas id="provider-chart" height="200"></canvas>
    </div>
    <div class="card accent-green">
      <div class="stat-label" style="margin-bottom:12px">Cost by Agent</div>
      <div id="agent-costs"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê AGENTS ‚ïê‚ïê‚ïê -->
<div class="section" id="sec-agents">
  <div class="page-header">
    <h1>Agent Network</h1>
    <p>Organization chart, skills, and documents</p>
  </div>
  <div class="tab-group">
    <button class="tab-btn active" data-agent-tab="org">Org Chart</button>
    <button class="tab-btn" data-agent-tab="docs">Documents</button>
  </div>
  <div id="agent-org" class="agent-panel">
    <div class="card accent-purple">
      <div class="org-chart" id="org-chart-container">
        <!-- Dynamically populated by loadAgents() -->
      </div>
    </div>
  </div>
  <div id="agent-docs" class="agent-panel" style="display:none">
    <div class="grid grid-1" id="docs-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCHEDULE ‚ïê‚ïê‚ïê -->
<div class="section" id="sec-schedule">
  <div class="page-header">
    <h1>Schedule</h1>
    <p>Cron jobs and automated tasks</p>
  </div>
  <div class="grid grid-1" id="schedule-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê JOURNAL ‚ïê‚ïê‚ïê -->
<div class="section" id="sec-journal">
  <div class="page-header">
    <h1>Trading Journal</h1>
    <p>Daily entries with market regime, agent reasoning, trades & lessons</p>
  </div>
  <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
    <button onclick="generateJournal()" style="background:var(--purple);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px">üìù Generate Today</button>
    <span id="journal-gen-status" style="font-size:12px;color:var(--text-dim)"></span>
  </div>
  <div class="grid grid-2">
    <div class="journal-list" id="journal-list"></div>
    <div class="journal-viewer" id="journal-viewer">
      <div style="text-align:center;color:var(--text-muted);padding-top:100px">Select a date to view</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê 2ND BRAIN ‚ïê‚ïê‚ïê -->
<div class="section" id="sec-brain">
  <div class="page-header">
    <h1>2nd Brain</h1>
    <p>Knowledge base and verified learnings</p>
  </div>
  <input class="search-bar" id="brain-search" placeholder="Search knowledge..." oninput="loadBrain()">
  <div class="tag-row" id="brain-tags">
    <span class="tag active" data-tag="">All</span>
    <span class="tag" data-tag="Trading">Trading</span>
    <span class="tag" data-tag="Knowledge">Knowledge</span>
    <span class="tag" data-tag="Places">Places</span>
    <span class="tag" data-tag="Notes">Notes</span>
  </div>
  <div class="grid grid-1" id="brain-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê FINANCE ‚ïê‚ïê‚ïê -->
<div class="section" id="sec-finance">
  <div class="page-header">
    <h1>üí∞ Financial Report</h1>
    <p>Receipt tracking & spending analysis for Snake</p>
  </div>

  <!-- Filters -->
  <div class="card accent-purple" style="margin-bottom:24px">
    <div style="display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap">
      <div>
        <label class="stat-label">From</label>
        <input type="date" id="fin-start" class="search-bar" style="width:180px;padding:8px 12px">
      </div>
      <div>
        <label class="stat-label">To</label>
        <input type="date" id="fin-end" class="search-bar" style="width:180px;padding:8px 12px">
      </div>
      <div>
        <label class="stat-label">Category</label>
        <select id="fin-category" class="search-bar" style="width:180px;padding:8px 12px">
          <option value="">All Categories</option>
        </select>
      </div>
      <button onclick="loadFinance()" style="padding:8px 24px;background:var(--purple);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-family:inherit;font-size:14px">Apply</button>
      <button onclick="document.getElementById('fin-start').value='';document.getElementById('fin-end').value='';document.getElementById('fin-category').value='';loadFinance()" style="padding:8px 16px;background:var(--border);color:var(--text-dim);border:none;border-radius:8px;cursor:pointer;font-family:inherit;font-size:13px">Clear</button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-4" id="fin-summary" style="margin-bottom:24px">
    <div class="card accent-green"><div class="stat-label">Total Spent</div><div class="stat-value text-green" id="fin-total">$0</div></div>
    <div class="card accent-purple"><div class="stat-label">Receipts</div><div class="stat-value text-purple" id="fin-count">0</div></div>
    <div class="card accent-teal"><div class="stat-label">Avg per Receipt</div><div class="stat-value text-teal" id="fin-avg">$0</div></div>
    <div class="card accent-yellow"><div class="stat-label">Top Category</div><div class="stat-value text-yellow" id="fin-top-cat">-</div></div>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-2" style="margin-bottom:24px">
    <div class="card accent-purple">
      <h3 style="margin-bottom:16px;font-size:16px">Spending by Category</h3>
      <canvas id="fin-cat-chart" height="260"></canvas>
    </div>
    <div class="card accent-teal">
      <h3 style="margin-bottom:16px;font-size:16px">Monthly Spending</h3>
      <canvas id="fin-month-chart" height="260"></canvas>
    </div>
  </div>

  <!-- Top Stores -->
  <div class="card accent-orange" style="margin-bottom:24px">
    <h3 style="margin-bottom:16px;font-size:16px">üè™ Top Stores</h3>
    <div id="fin-stores"></div>
  </div>

  <!-- Receipt Table -->
  <div class="card" style="margin-bottom:24px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="font-size:16px">üìã All Receipts</h3>
      <input class="search-bar" id="fin-search" placeholder="Search receipts..." style="width:300px;padding:8px 12px" oninput="filterReceiptTable()">
    </div>
    <div class="table-wrap">
      <table id="fin-table">
        <thead><tr><th>Date</th><th>Store</th><th>Category</th><th>Total</th><th>Payment</th><th>Items</th></tr></thead>
        <tbody id="fin-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

</div><!-- /main -->

<script>
// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
const navItems = document.querySelectorAll('.nav-item');
const sections = document.querySelectorAll('.section');
navItems.forEach(item => {
  item.addEventListener('click', () => {
    navItems.forEach(n => n.classList.remove('active'));
    sections.forEach(s => s.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('sec-' + item.dataset.tab).classList.add('active');
    loadTab(item.dataset.tab);
  });
});

// ‚îÄ‚îÄ Agent tabs ‚îÄ‚îÄ
document.querySelectorAll('[data-agent-tab]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-agent-tab]').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.agent-panel').forEach(p => p.style.display = 'none');
    btn.classList.add('active');
    document.getElementById('agent-' + btn.dataset.agentTab).style.display = 'block';
  });
});

// ‚îÄ‚îÄ Brain tags ‚îÄ‚îÄ
document.querySelectorAll('#brain-tags .tag').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('#brain-tags .tag').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    loadBrain();
  });
});

const api = async (url, opts) => {
  document.getElementById('refresh-spin').style.display = 'inline';
  try {
    const r = await fetch(url, opts);
    const d = await r.json();
    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
    return d;
  } catch(e) { return null; }
  finally { document.getElementById('refresh-spin').style.display = 'none'; }
};
const fmt$ = (v) => '$' + Number(v).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
const fmtK = (v) => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'K' : v;

let equityChart = null, providerChart = null;

async function loadTab(tab) {
  if (tab === 'overview') await loadOverview();
  else if (tab === 'trading') await loadTrading();
  else if (tab === 'tokens') await loadTokens();
  else if (tab === 'agents') await loadAgents();
  else if (tab === 'schedule') await loadSchedule();
  else if (tab === 'journal') await loadJournal();
  else if (tab === 'brain') await loadBrain();
  else if (tab === 'finance') await loadFinance();
}

async function loadOverview() {
  const d = await api('/api/overview');
  if (!d) return;
  document.getElementById('ov-equity').textContent = fmt$(d.equity);
  const pnlEl = document.getElementById('ov-pnl');
  pnlEl.textContent = (d.today_pnl >= 0 ? '+' : '') + fmt$(d.today_pnl);
  pnlEl.className = 'stat-value ' + (d.today_pnl >= 0 ? 'text-green' : 'text-red');
  document.getElementById('ov-positions').textContent = d.open_positions;
  document.getElementById('ov-winrate').textContent = d.win_rate + '%';
  document.getElementById('ov-trades').textContent = d.total_trades;
  document.getElementById('ov-cash').textContent = fmt$(d.cash);
}

async function loadTrading() {
  // Positions
  const pos = await api('/api/positions') || [];
  const tbody = document.getElementById('positions-body');
  if (pos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No open positions</td></tr>';
  } else {
    tbody.innerHTML = pos.map(p => `<tr>
      <td style="font-weight:600">${p.symbol}</td><td>${p.qty}</td>
      <td>${fmt$(p.entry)}</td><td>${fmt$(p.current)}</td>
      <td class="${p.pnl>=0?'text-green':'text-red'}">${(p.pnl>=0?'+':'')+fmt$(p.pnl)}</td>
      <td class="${p.pnl_pct>=0?'text-green':'text-red'}">${(p.pnl_pct>=0?'+':'')+p.pnl_pct.toFixed(2)}%</td>
    </tr>`).join('');
  }

  // Equity chart
  const curve = await api('/api/equity_history') || [];
  const ctx = document.getElementById('equity-chart').getContext('2d');
  if (equityChart) equityChart.destroy();
  equityChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: curve.map((c,i) => {if(i===0) return 'Start'; const d=new Date(c.timestamp); return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});}),
      datasets: [{
        label: 'Equity',
        data: curve.map(c => c.equity),
        borderColor: '#6D5EF6',
        backgroundColor: 'rgba(109,94,246,0.1)',
        fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2
      }]
    },
    options: {responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{title:function(items){const c=curve[items[0].dataIndex];return c.trade||c.timestamp||'Start';},label:function(item){return '$'+item.raw.toLocaleString();}}}},scales:{x:{display:true,grid:{color:'#1E293B'},ticks:{color:'#64748B',maxRotation:45,autoSkip:true,maxTicksLimit:8}},y:{grid:{color:'#1E293B'},ticks:{color:'#64748B',callback:function(v){return '$'+v.toLocaleString();}}}}}
  });

  // Recent trades
  const trades = await api('/api/trades') || [];
  const feed = document.getElementById('trades-feed');
  if (trades.length === 0) {
    feed.innerHTML = '<div style="text-align:center;color:var(--text-muted)">No trades yet</div>';
  } else {
    feed.innerHTML = trades.slice(0,15).map(t => `<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between">
      <span><strong>${t.symbol||'‚Äî'}</strong> ${t.side||''} ${t.qty||''}</span>
      <span class="${(t.pnl||0)>=0?'text-green':'text-red'}">${t.pnl!=null?((t.pnl>=0?'+':'')+Number(t.pnl).toFixed(2)):'‚Äî'}</span>
    </div>`).join('');
  }
}

async function loadTokens() {
  const d = await api('/api/tokens');
  if (!d) return;
  document.getElementById('tk-budget-text').textContent = fmt$(d.budget_used);
  document.getElementById('tk-budget-total').textContent = fmt$(d.budget);
  const pct = Math.min((d.budget_used / d.budget) * 100, 100);
  const bar = document.getElementById('tk-budget-bar');
  bar.style.width = pct + '%';
  bar.style.background = pct > 80 ? 'var(--red)' : pct > 60 ? 'var(--yellow)' : 'var(--purple)';

  document.getElementById('tk-used').textContent = fmt$(d.budget_used);
  document.getElementById('tk-daily').textContent = fmt$(d.daily_avg);
  document.getElementById('tk-projected').textContent = fmt$(d.projected_monthly);
  document.getElementById('tk-tokens').textContent = fmtK(d.total_tokens);

  // Input/Output breakdown
  const inp = d.input_tokens || 0;
  const out = d.output_tokens || 0;
  const total = inp + out || 1;
  document.getElementById('tk-input').textContent = fmtK(inp);
  document.getElementById('tk-output').textContent = fmtK(out);
  document.getElementById('tk-input-pct').textContent = `${((inp/total)*100).toFixed(1)}% of total`;
  document.getElementById('tk-output-pct').textContent = `${((out/total)*100).toFixed(1)}% of total`;
  document.getElementById('tk-sessions').textContent = (d.sessions_parsed || 0).toLocaleString();
  document.getElementById('tk-days').textContent = d.days_active || '‚Äî';

  // Model breakdown table
  const modelDiv = document.getElementById('model-costs');
  if (d.by_model && d.by_model.length) {
    modelDiv.innerHTML = `<div style="display:grid;grid-template-columns:1fr 90px 90px 80px 60px;gap:4px;font-size:13px;color:var(--text-dim)">
      <div style="font-weight:600;color:var(--text)">Model</div><div style="text-align:right;font-weight:600;color:var(--text)">Input</div><div style="text-align:right;font-weight:600;color:var(--text)">Output</div><div style="text-align:right;font-weight:600;color:var(--text)">Cost</div><div style="text-align:right;font-weight:600;color:var(--text)">Calls</div>
      ${d.by_model.map(m => `<div style="color:var(--teal)">${m.model}</div><div style="text-align:right">${fmtK(m.input)}</div><div style="text-align:right">${fmtK(m.output)}</div><div style="text-align:right">${fmt$(m.cost)}</div><div style="text-align:right">${m.calls}</div>`).join('')}
    </div>`;
  } else {
    modelDiv.innerHTML = '<div style="color:var(--text-muted)">No model data available</div>';
  }

  // Provider chart
  const ctx = document.getElementById('provider-chart').getContext('2d');
  if (providerChart) providerChart.destroy();
  const colors = ['#6D5EF6','#25D27B','#20C4C6','#F59E0B','#EF4444'];
  providerChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: (d.by_provider||[]).map(p => p.provider),
      datasets: [{data:(d.by_provider||[]).map(p => p.tokens), backgroundColor: colors, borderWidth:0}]
    },
    options: {responsive:true,plugins:{legend:{position:'bottom',labels:{color:'#94A3B8',font:{size:12}}}}}
  });

  // Agent costs
  const ac = document.getElementById('agent-costs');
  ac.innerHTML = (d.by_agent||[]).map((a,i) => `<div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
    <div><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${colors[i]};margin-right:8px"></span>${a.agent}</div>
    <div>${fmt$(a.cost)} ¬∑ ${fmtK(a.tokens)} tokens</div>
  </div>`).join('');

  // Store data for line chart
  window._tokenData = d;
  renderModelChart('daily');
}

let modelLineChart = null;
const modelChartColors = ['#6D5EF6','#25D27B','#20C4C6','#F59E0B','#EF4444','#EC4899','#8B5CF6','#14B8A6','#F97316','#64748B'];

function renderModelChart(mode) {
  document.getElementById('tok-daily-btn').classList.toggle('active', mode === 'daily');
  document.getElementById('tok-monthly-btn').classList.toggle('active', mode === 'monthly');

  const d = window._tokenData;
  if (!d) return;

  const ctx = document.getElementById('model-line-chart').getContext('2d');
  if (modelLineChart) modelLineChart.destroy();

  if (mode === 'daily') {
    // by_model_day: {model: [{date, tokens}]}
    const bmd = d.by_model_day || {};
    const allDates = [...new Set(Object.values(bmd).flatMap(arr => arr.map(x => x.date)))].sort();
    // Show last 30 days max
    const dates = allDates.slice(-30);

    const datasets = Object.entries(bmd)
      .sort((a,b) => {
        const sumA = a[1].reduce((s,x) => s + x.tokens, 0);
        const sumB = b[1].reduce((s,x) => s + x.tokens, 0);
        return sumB - sumA;
      })
      .slice(0, 8) // top 8 models
      .map(([model, points], i) => {
        const dateMap = Object.fromEntries(points.map(p => [p.date, p.tokens]));
        return {
          label: model,
          data: dates.map(d => dateMap[d] || 0),
          borderColor: modelChartColors[i % modelChartColors.length],
          backgroundColor: modelChartColors[i % modelChartColors.length] + '22',
          borderWidth: 2,
          tension: 0.3,
          fill: false,
          pointRadius: 2,
        };
      });

    modelLineChart = new Chart(ctx, {
      type: 'line',
      data: { labels: dates.map(d => d.slice(5)), datasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { ticks: { color: '#64748B', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#1E293B' } },
          y: { ticks: { color: '#64748B', callback: v => fmtK(v) }, grid: { color: '#1E293B' } }
        },
        plugins: {
          legend: { position: 'bottom', labels: { color: '#94A3B8', font: { size: 11 }, usePointStyle: true, pointStyle: 'circle' } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmtK(ctx.parsed.y) + ' tokens' } }
        }
      }
    });
  } else {
    // Monthly view from by_day aggregated per model
    const bmd = d.by_model_day || {};
    // Aggregate to monthly
    const monthlyByModel = {};
    for (const [model, points] of Object.entries(bmd)) {
      monthlyByModel[model] = {};
      for (const p of points) {
        const m = p.date.slice(0, 7);
        monthlyByModel[model][m] = (monthlyByModel[model][m] || 0) + p.tokens;
      }
    }
    const allMonths = [...new Set(Object.values(monthlyByModel).flatMap(obj => Object.keys(obj)))].sort();

    const datasets = Object.entries(monthlyByModel)
      .sort((a,b) => {
        const sumA = Object.values(a[1]).reduce((s,v) => s+v, 0);
        const sumB = Object.values(b[1]).reduce((s,v) => s+v, 0);
        return sumB - sumA;
      })
      .slice(0, 8)
      .map(([model, months], i) => ({
        label: model,
        data: allMonths.map(m => months[m] || 0),
        borderColor: modelChartColors[i % modelChartColors.length],
        backgroundColor: modelChartColors[i % modelChartColors.length] + '44',
        borderWidth: 2,
        fill: true,
      }));

    modelLineChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: allMonths, datasets },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true, ticks: { color: '#64748B' }, grid: { color: '#1E293B' } },
          y: { stacked: true, ticks: { color: '#64748B', callback: v => fmtK(v) }, grid: { color: '#1E293B' } }
        },
        plugins: {
          legend: { position: 'bottom', labels: { color: '#94A3B8', font: { size: 11 }, usePointStyle: true } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmtK(ctx.parsed.y) + ' tokens' } }
        }
      }
    });
  }
}

async function loadAgents() {
  const d = await api('/api/agents');
  if (!d) return;

  // Build org chart dynamically
  const org = d.org || {};
  const agents = org.agents || [];
  const container = document.getElementById('org-chart-container');

  const icons = {
    'main (boybot)':'ü§ñ','trading-ops':'‚ö°','architect':'üèóÔ∏è','qa':'üß™',
    'strategy':'üìä','finance':'üí∞','travel':'‚úàÔ∏è','vita':'üíä','image':'üñºÔ∏è','accountant':'üßæ'
  };
  const colors = {
    'main (boybot)':'var(--purple)','trading-ops':'var(--teal)','architect':'var(--orange)',
    'qa':'var(--green)','strategy':'var(--red)','finance':'var(--green)','travel':'var(--teal)','vita':'var(--green)',
    'image':'var(--yellow, #EAB308)','accountant':'var(--yellow, #EAB308)'
  };
  const tradingTeam = ['trading-ops','architect','qa','strategy','finance'];
  const personalTeam = ['travel','vita','image','accountant'];

  const makeNode = (name, role, model, color, status) => `
    <div class="org-node" style="border-color:${color||'var(--purple)'}">
      <div class="status-dot ${status==='active'?'active':'disabled'}"></div>
      <div class="name">${icons[name]||'üîπ'} ${name}</div>
      <div class="role">${role}</div>
      <div class="model-tag">${model}</div>
    </div>`;

  const manager = agents.find(a => a.name.includes('main') || a.name.includes('boybot'));
  const vita = agents.find(a => a.name === 'vita');
  const trading = agents.filter(a => tradingTeam.includes(a.name));
  const personal = agents.filter(a => personalTeam.includes(a.name) && a.name !== 'vita');
  // Catch any agents not in known groups
  const known = new Set([manager?.name, ...tradingTeam, ...personalTeam].filter(Boolean));
  const other = agents.filter(a => !known.has(a.name));

  let html = `
    <div class="org-node" style="border-color:var(--yellow)">
      <div class="name">üêç ${org.owner?.name || 'Snake'}</div>
      <div class="role">Owner</div>
    </div>
    <div class="org-connector"></div>`;

  // Main + Vita side by side (both report to Snake)
  html += '<div class="org-row">';
  if (manager) {
    html += makeNode(manager.name, manager.role, manager.model, 'var(--purple)', manager.status);
  }
  if (vita) {
    html += makeNode(vita.name, vita.role, vita.model, colors[vita.name], vita.status);
  }
  html += '</div><div class="org-connector"></div>';

  if (trading.length) {
    html += '<div class="org-row-label">Trading Floor</div><div class="org-row">';
    trading.forEach(a => { html += makeNode(a.name, a.role, a.model, colors[a.name], a.status); });
    html += '</div><div class="org-connector"></div>';
  }

  if (personal.length) {
    html += '<div class="org-row-label">Personal</div><div class="org-row">';
    personal.forEach(a => { html += makeNode(a.name, a.role, a.model, colors[a.name], a.status); });
    html += '</div>';
  }

  if (other.length) {
    html += '<div class="org-connector"></div><div class="org-row-label">Other</div><div class="org-row">';
    other.forEach(a => { html += makeNode(a.name, a.role, a.model, colors[a.name]||'var(--purple)', a.status); });
    html += '</div>';
  }

  container.innerHTML = html;

  // Docs list
  const dl = document.getElementById('docs-list');
  dl.innerHTML = (d.documents||[]).map(doc => `<div class="card accent-purple" style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>${doc.name}</strong><div style="font-size:12px;color:var(--text-dim)">${(doc.size/1024).toFixed(1)} KB</div></div>
    <span class="badge badge-purple">Workspace</span>
  </div>`).join('');
}

async function loadSchedule() {
  const jobs = await api('/api/schedule') || [];
  const el = document.getElementById('schedule-list');
  el.innerHTML = jobs.map(j => `<div class="cron-card">
    <div class="cron-stripe" style="background:${j.color||'var(--purple)'}"></div>
    <div class="cron-info"><h3>${j.name}</h3><p>${j.description||''}</p></div>
    <div class="cron-meta">
      <span class="badge ${j.status==='Active'||j.status==='Running'?'badge-green':j.status==='Paused'?'badge-yellow':'badge-purple'}">${j.status||'Active'}</span>
      <div style="margin-top:4px">${j.schedule||''}</div>
    </div>
  </div>`).join('') || '<div class="card" style="text-align:center;color:var(--text-muted)">No scheduled jobs</div>';
}

async function loadJournal() {
  const entries = await api('/api/journal') || [];
  const list = document.getElementById('journal-list');
  list.innerHTML = entries.map(e => {
    const icon = e.type === 'trading' ? 'üìä' : 'üìù';
    const borderColor = e.type === 'trading' ? 'var(--green)' : 'var(--purple)';
    const tags = (e.tags||[]).map(t => {
      let color = 'var(--purple)';
      if (t === 'Bullish') color = 'var(--green)';
      else if (t === 'Bearish') color = 'var(--red)';
      else if (t.includes('blocked')) color = 'var(--yellow, #EAB308)';
      return `<span class="tag" style="font-size:10px;padding:2px 8px;border-color:${color};color:${color}">${escHtml(t)}</span>`;
    }).join('');
    return `<div class="journal-item" style="border-left-color:${borderColor}" onclick="viewJournal('${e.date}','${e.type||'memory'}')">
      <div class="date">${icon} ${e.date}</div>
      <div class="preview">${escHtml(e.preview)}</div>
      <div class="tag-row">${tags}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-muted)">No journal entries yet. Click "Generate Today" to create one.</div>';
}

async function viewJournal(date, type) {
  const d = await api('/api/journal/' + date);
  if (!d) return;
  const viewer = document.getElementById('journal-viewer');
  let html = '';

  // Trading journal (rich view)
  if (d.trading) {
    const t = d.trading;
    html += `<h2 style="margin-bottom:4px">üìä Trading Journal ‚Äî ${date}</h2>`;

    // Regime badge
    if (t.market_regime) {
      const regimeColor = t.market_regime === 'Bullish' ? 'var(--green)' :
                          t.market_regime === 'Bearish' ? 'var(--red)' : 'var(--yellow, #EAB308)';
      html += `<div style="margin:12px 0"><span style="background:${regimeColor}22;color:${regimeColor};padding:6px 14px;border-radius:20px;font-weight:600;font-size:14px">${t.market_regime}</span></div>`;
    }

    // Shadow analysis
    if (t.shadow_analysis) {
      const s = t.shadow_analysis;
      html += `<div style="background:#111827;border-radius:8px;padding:16px;margin:12px 0">
        <h3 style="margin:0 0 8px;font-size:14px">üîÆ Shadow Analysis</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:13px">
          <div><span style="color:var(--text-dim)">Predictions</span><br><strong>${s.total_predictions}</strong></div>
          <div><span style="color:var(--text-dim)">Symbols</span><br><strong>${s.unique_symbols}</strong></div>
          <div><span style="color:var(--text-dim)">Bull/Bear</span><br><strong style="color:var(--green)">${s.hmm_bull_pct}%</strong> / <strong style="color:var(--red)">${s.hmm_bear_pct}%</strong></div>
        </div>
      </div>`;
    }

    // Agent signals
    if (t.agent_signals && Object.keys(t.agent_signals).length > 0) {
      html += `<h3 style="margin:16px 0 8px">ü§ñ Agent Signals</h3>`;
      for (const [agent, info] of Object.entries(t.agent_signals)) {
        html += `<div style="background:#111827;border-radius:8px;padding:12px;margin:6px 0">
          <strong style="text-transform:capitalize">${escHtml(agent)}</strong>
          <span style="color:var(--text-dim);font-size:12px"> ‚Äî ${info.total_signals} signals, ${info.unique_symbols} symbols</span>`;
        if (info.top_by_strength) {
          html += '<div style="margin-top:8px;font-size:13px">';
          for (const sig of info.top_by_strength.slice(0, 3)) {
            const dir = sig.signal_value > 0 ? 'üü¢ LONG' : sig.signal_value < 0 ? 'üî¥ SHORT' : '‚ö™ NEUTRAL';
            html += `<div style="padding:2px 0">‚Ä¢ <strong>${escHtml(sig.symbol)}</strong>: ${sig.signal_value.toFixed(4)} (${dir}, conf: ${(sig.confidence * 100).toFixed(1)}%)</div>`;
          }
          html += '</div>';
        }
        html += '</div>';
      }
    }

    // Trades
    html += `<h3 style="margin:16px 0 8px">üí∞ Trades</h3>`;
    if (t.trades_executed && t.trades_executed.length > 0) {
      for (const tr of t.trades_executed) {
        const pnl = parseFloat(tr.pnl) || 0;
        const pnlColor = pnl >= 0 ? 'var(--green)' : 'var(--red)';
        html += `<div style="background:#111827;border-radius:8px;padding:12px;margin:6px 0;display:flex;justify-content:space-between">
          <span><strong>${tr.side} ${escHtml(tr.symbol)}</strong> ‚Äî qty: ${tr.quantity}, $${parseFloat(tr.price).toFixed(2)}</span>
          <span style="color:${pnlColor};font-weight:600">$${pnl.toFixed(2)}</span>
        </div>`;
      }
    } else {
      html += `<div style="color:var(--text-dim);font-style:italic">No trades executed</div>`;
    }

    // Blocked
    if (t.trades_blocked > 0) {
      html += `<div style="margin:12px 0;padding:12px;background:#7C2D1233;border-radius:8px;border-left:3px solid var(--red)">
        <strong>‚ö†Ô∏è ${t.trades_blocked} cycles blocked</strong>`;
      if (t.events_summary && t.events_summary.block_reasons) {
        for (const r of t.events_summary.block_reasons.filter(x => x)) {
          html += `<div style="font-size:12px;color:var(--text-dim);margin-top:4px">‚Ä¢ ${escHtml(r)}</div>`;
        }
      }
      html += '</div>';
    }

    // Portfolio
    if (t.portfolio_snapshot) {
      const p = t.portfolio_snapshot;
      const pct = ((p.equity - 5000) / 5000 * 100).toFixed(1);
      const pctColor = pct >= 0 ? 'var(--green)' : 'var(--red)';
      html += `<div style="background:#111827;border-radius:8px;padding:16px;margin:12px 0">
        <h3 style="margin:0 0 8px;font-size:14px">üíº Portfolio</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:13px">
          <div><span style="color:var(--text-dim)">Equity</span><br><strong>$${p.equity.toLocaleString()}</strong></div>
          <div><span style="color:var(--text-dim)">Cash</span><br><strong>$${p.cash.toLocaleString()}</strong></div>
          <div><span style="color:var(--text-dim)">Since Start</span><br><strong style="color:${pctColor}">${pct}%</strong></div>
        </div>
      </div>`;
    }

    // Lessons
    if (t.lessons && t.lessons.length > 0) {
      html += '<h3 style="margin:16px 0 8px">üìö Lessons</h3>';
      for (const l of t.lessons) {
        html += `<div style="padding:4px 0;font-size:13px">‚Ä¢ ${escHtml(l)}</div>`;
      }
    }
    html += '<hr style="border-color:#1E293B;margin:20px 0">';
  }

  // Trading narrative (markdown)
  if (d.trading_narrative) {
    html += `<details style="margin:8px 0"><summary style="cursor:pointer;color:var(--purple);font-size:13px">üìÑ Raw Narrative</summary>
      <pre style="white-space:pre-wrap;font-size:12px;margin-top:8px;background:#0D1525;padding:16px;border-radius:8px">${escHtml(d.trading_narrative)}</pre>
    </details>`;
  }

  // Memory notes
  if (d.memory) {
    html += `<h3 style="margin:16px 0 8px">üìù Memory Notes</h3>`;
    let memHtml = escHtml(d.memory)
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h1>$1</h1>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/`(.+?)`/g, '<code>$1</code>')
      .replace(/^- (.+)$/gm, '‚Ä¢ $1<br>')
      .replace(/\n/g, '<br>');
    html += memHtml;
  }

  viewer.innerHTML = html || '<div style="color:var(--text-muted)">No data for this date</div>';
}

async function generateJournal() {
  const status = document.getElementById('journal-gen-status');
  status.textContent = 'Generating...';
  const today = new Date().toISOString().split('T')[0];
  const res = await api('/api/journal/generate/' + today, {method: 'POST'});
  if (res && !res.error) {
    status.textContent = '‚úÖ Generated!';
    await loadJournal();
    viewJournal(today, 'trading');
  } else {
    status.textContent = '‚ùå ' + (res?.error || 'Failed');
  }
  setTimeout(() => status.textContent = '', 3000);
}

let brainTag = '';
async function loadBrain() {
  const activeTag = document.querySelector('#brain-tags .tag.active');
  brainTag = activeTag ? activeTag.dataset.tag : '';
  const q = document.getElementById('brain-search').value;
  const entries = await api('/api/brain?q=' + encodeURIComponent(q)) || [];
  const filtered = brainTag ? entries.filter(e => (e.tags||[]).includes(brainTag)) : entries;
  const el = document.getElementById('brain-list');
  el.innerHTML = filtered.map(e => `<div class="brain-entry">
    <h3>${escHtml(e.title)}</h3>
    <div class="tag-row">${(e.tags||[]).map(t => '<span class="tag" style="font-size:10px;padding:2px 8px">'+escHtml(t)+'</span>').join('')}</div>
    <div class="body">${escHtml(e.body)}</div>
    <div style="margin-top:8px;font-size:11px;color:var(--text-muted)">Source: ${escHtml(e.source||'')}</div>
  </div>`).join('') || '<div class="card" style="text-align:center;color:var(--text-muted)">No entries found</div>';
}

function escHtml(s) { const d=document.createElement('div');d.textContent=s||'';return d.innerHTML; }

// ‚îÄ‚îÄ WebSocket live updates ‚îÄ‚îÄ
function connectWS() {
  const ws = new WebSocket('ws://' + location.host + '/ws/feed');
  ws.onmessage = (e) => {
    const d = JSON.parse(e.data);
    if (d.type === 'status_update' && document.getElementById('sec-overview').classList.contains('active')) {
      document.getElementById('ov-equity').textContent = fmt$(d.equity);
    }
  };
  ws.onclose = () => setTimeout(connectWS, 3000);
}

// ‚îÄ‚îÄ Finance ‚îÄ‚îÄ
let finCatChart = null, finMonthChart = null;
let finAllReceipts = [];

async function loadFinance() {
  const start = document.getElementById('fin-start').value;
  const end = document.getElementById('fin-end').value;
  const cat = document.getElementById('fin-category').value;
  let url = '/api/receipts?';
  if (start) url += `start=${start}&`;
  if (end) url += `end=${end}&`;
  if (cat) url += `category=${encodeURIComponent(cat)}&`;
  const d = await api(url);
  if (!d) return;
  const s = d.summary;
  finAllReceipts = d.receipts;

  // Summary cards
  document.getElementById('fin-total').textContent = fmt$(s.total_spent);
  document.getElementById('fin-count').textContent = s.receipt_count;
  document.getElementById('fin-avg').textContent = s.receipt_count ? fmt$(s.total_spent / s.receipt_count) : '$0';
  const topCat = Object.entries(s.by_category)[0];
  document.getElementById('fin-top-cat').textContent = topCat ? topCat[0] : '-';

  // Populate category dropdown (only on first load)
  const sel = document.getElementById('fin-category');
  if (sel.options.length <= 1 && s.categories) {
    s.categories.forEach(c => {
      const o = document.createElement('option');
      o.value = c; o.textContent = c;
      sel.appendChild(o);
    });
    if (cat) sel.value = cat;
  }

  // Category donut chart
  const catLabels = Object.keys(s.by_category);
  const catData = Object.values(s.by_category);
  const catColors = ['#6D5EF6','#25D27B','#20C4C6','#F59E0B','#EF4444','#F97316','#EC4899','#8B5CF6','#06B6D4','#84CC16','#D946EF','#14B8A6','#FB923C','#A855F7','#38BDF8','#FBBF24'];
  if (finCatChart) finCatChart.destroy();
  finCatChart = new Chart(document.getElementById('fin-cat-chart'), {
    type: 'doughnut',
    data: { labels: catLabels, datasets: [{ data: catData, backgroundColor: catColors.slice(0, catLabels.length), borderWidth: 0 }] },
    options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: '#94A3B8', font: { size: 11 }, padding: 8 } } } }
  });

  // Monthly bar chart
  const monthLabels = Object.keys(s.by_month);
  const monthData = Object.values(s.by_month);
  if (finMonthChart) finMonthChart.destroy();
  finMonthChart = new Chart(document.getElementById('fin-month-chart'), {
    type: 'bar',
    data: { labels: monthLabels, datasets: [{ label: 'Spent', data: monthData, backgroundColor: '#6D5EF6', borderRadius: 4 }] },
    options: { responsive: true, scales: { x: { ticks: { color: '#64748B', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: '#64748B', callback: v => '$' + v.toLocaleString() }, grid: { color: '#1E293B' } } }, plugins: { legend: { display: false } } }
  });

  // Top stores
  const storesDiv = document.getElementById('fin-stores');
  if (s.top_stores.length) {
    const maxStore = s.top_stores[0].total;
    storesDiv.innerHTML = s.top_stores.map(s => `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div style="width:200px;font-size:13px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${s.store}">${s.store}</div>
        <div style="flex:1"><div class="progress-bar"><div class="progress-fill" style="width:${(s.total/maxStore*100).toFixed(1)}%;background:var(--orange)"></div></div></div>
        <div style="width:80px;text-align:right;font-size:13px;font-weight:600;color:var(--orange)">$${s.total.toLocaleString()}</div>
      </div>
    `).join('');
  } else {
    storesDiv.innerHTML = '<p style="color:var(--text-muted)">No data</p>';
  }

  // Receipt table
  renderReceiptTable(d.receipts);
}

function renderReceiptTable(receipts) {
  const tbody = document.getElementById('fin-tbody');
  const categories = ['Meal','Self','Health','Grocery','Car Maintenance','Travel','Entertainment','Home','Gas','Electronics','Pet','Parking','Subscription','Gift','Education','Uncategorized'];
  const colors = { Meal: 'green', Self: 'purple', Health: 'teal', Grocery: 'green', 'Car Maintenance': 'yellow', Travel: 'purple', Entertainment: 'yellow', Home: 'teal', Gas: 'yellow', Electronics: 'purple', Pet: 'green', Parking: 'red', Subscription: 'teal', Gift: 'purple', Education: 'teal' };
  tbody.innerHTML = receipts.sort((a,b) => (b.date||'').localeCompare(a.date||'')).map(r => {
    const cat = r.category || 'Uncategorized';
    const c = colors[cat] || 'purple';
    const opts = categories.map(o => `<option value="${o}" ${o===cat?'selected':''}>${o}</option>`).join('');
    const idx = r._idx !== undefined ? r._idx : '';
    return `<tr>
      <td style="white-space:nowrap">${r.date || '-'}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(r.store||'').replace(/"/g,'&quot;')}">${r.store || '-'}</td>
      <td><select class="cat-select badge-${c}" data-idx="${idx}" onchange="updateCategory(this)" style="background:rgba(var(--${c}-rgb,109,94,246),.15);color:var(--${c},#6D5EF6);border:1px solid rgba(var(--${c}-rgb,109,94,246),.3);border-radius:12px;padding:3px 8px;font-size:12px;cursor:pointer;outline:none">${opts}</select></td>
      <td style="font-weight:600;color:var(--green)">$${parseFloat(r.total||0).toFixed(2)}</td>
      <td style="color:var(--text-muted);font-size:12px">${r.payment_method || '-'}</td>
      <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-dim);font-size:12px" title="${(r.items||'').replace(/"/g,'&quot;')}">${r.items || '-'}</td>
    </tr>`;
  }).join('');
}

async function updateCategory(el) {
  const idx = el.dataset.idx;
  const newCat = el.value;
  if (idx === '') return;
  el.disabled = true;
  el.style.opacity = '0.5';
  try {
    const res = await fetch('/api/receipts/' + idx + '/category', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({category: newCat})
    });
    const d = await res.json();
    if (d.ok) {
      // Update local data
      const orig = finAllReceipts.find(r => r._idx == idx);
      if (orig) orig.category = newCat;
      el.style.opacity = '1';
      // Flash green briefly
      el.style.boxShadow = '0 0 8px var(--green)';
      setTimeout(() => { el.style.boxShadow = ''; }, 1000);
    } else {
      alert('Failed: ' + (d.error || 'unknown'));
      el.style.opacity = '1';
    }
  } catch(e) {
    alert('Error saving: ' + e.message);
    el.style.opacity = '1';
  }
  el.disabled = false;
}

function filterReceiptTable() {
  const q = document.getElementById('fin-search').value.toLowerCase();
  if (!q) return renderReceiptTable(finAllReceipts);
  renderReceiptTable(finAllReceipts.filter(r =>
    (r.store||'').toLowerCase().includes(q) || (r.items||'').toLowerCase().includes(q) || (r.category||'').toLowerCase().includes(q) || (r.date||'').includes(q)
  ));
}

// ‚îÄ‚îÄ Auto-refresh active tab ‚îÄ‚îÄ
let activeTab = 'overview';
let refreshTimer = null;

function startAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => {
    const tab = activeTab;
    // Only auto-refresh data-heavy tabs
    if (['overview','trading','agents','finance'].includes(tab)) {
      loadTab(tab);
    }
  }, 30000); // 30s refresh
}

// Override nav click to track active tab
document.querySelectorAll('.nav-item').forEach(n => {
  const origClick = n.onclick;
  n.addEventListener('click', () => {
    activeTab = n.dataset.tab;
    startAutoRefresh(); // reset timer on tab switch
  });
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadOverview();
connectWS();
startAutoRefresh();
</script>
</body>
</html>
